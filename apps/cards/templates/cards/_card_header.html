{% load static %}
<section class="card row" style="justify-content:space-between;align-items:center">
  <div class="row" style="gap:12px;align-items:center">
    {% if card.avatar_w128 %}
      <img src="{% url 'media:card_avatar_private' card.id 'w128' %}?v={{ card.avatar_rev }}" alt="Avatar de {{ card.title }}" width="64" height="64" style="border-radius:10px;object-fit:cover" />
    {% else %}
      <div style="width:64px;height:64px;border:1px solid var(--border);border-radius:10px;background:var(--bg-elev)"></div>
    {% endif %}
    <div>
      <h1 style="margin:0">{{ card.title }}</h1>
      <div class="muted">
        Status:
        <span class="status-indicator" title="{{ card.get_status_display }}">
          <span class="status-dot" data-status="{{ card.status }}" aria-hidden="true"></span>
          <span class="sr-only">{{ card.get_status_display }}</span>
        </span>
        {% if card.deactivation_marked %}<span class="badge">Marcado para desativação</span>{% endif %}
      </div>
    </div>
  </div>
  <!-- Ações desktop -->
  <div class="row" style="gap:8px; display:none" id="card-header">
    <form id="avatar-form" method="post" action="{% url 'cards:upload_avatar' card.id %}" enctype="multipart/form-data" hx-post="{% url 'cards:upload_avatar' card.id %}" hx-target="#card-header" hx-swap="outerHTML" class="row" style="gap:8px">
      {% csrf_token %}
      <input id="avatar-file" type="file" name="avatar" accept="image/*" class="input" required onchange="this.form.requestSubmit()" {% if card.deactivation_marked %}disabled{% endif %} />
      <button class="btn" {% if card.deactivation_marked %}disabled title="Bloqueado enquanto marcado"{% endif %}>Trocar avatar</button>
    </form>
  </div>

  <!-- Ações mobile: dropdown -->
  <details class="dropdown mobile-viewer">
    <summary class="btn" aria-haspopup="menu" aria-expanded="false" aria-label="Mais ações">
      <svg aria-hidden="true" width="18" height="18"><use href="{% static 'ui/icons.svg' %}#icon-ellipsis"></use></svg>
    </summary>
    <div class="menu" role="menu">
      <button role="menuitem" type="button" data-open-file="#avatar-file" {% if card.deactivation_marked %}disabled title="Bloqueado enquanto marcado"{% endif %}>Trocar avatar</button>
      {% if card.deactivation_marked %}
        <span role="menuitem" class="muted">Editar (bloqueado)</span>
      {% else %}
        <a role="menuitem" href="{% url 'cards:edit' card.id %}">Editar</a>
      {% endif %}
      {% if card.status != 'published' %}
        <button role="menuitem" hx-get="{% url 'cards:publish_modal' card.id %}" hx-target="#publish-modal" hx-swap="innerHTML">Publicar</button>
      {% endif %}
      {% if card.status == 'published' and card.nickname %}
        {% if card.deactivation_marked %}
          <span role="menuitem" class="muted" title="Desativado para visualização pública">Visualizar (desabilitado)</span>
        {% else %}
          <a role="menuitem" href="{{ viewer_base }}/@{{ card.nickname }}" target="_blank" rel="noopener">Visualizar</a>
        {% endif %}
      {% endif %}
      
      {% if card.status == 'published' %}
        {% if card.deactivation_marked %}
          <form role="none" method="post" action="{% url 'cards:reactivate' card.id %}" hx-post="{% url 'cards:reactivate' card.id %}" class="inline">
            {% csrf_token %}
            <button role="menuitem" style="width:100%;text-align:left">Reativar</button>
          </form>
        {% else %}
          <form role="none" method="post" action="{% url 'cards:mark_deactivation' card.id %}" hx-post="{% url 'cards:mark_deactivation' card.id %}" class="inline">
            {% csrf_token %}
            <button role="menuitem" style="width:100%;text-align:left">Marcar para desativação</button>
          </form>
        {% endif %}
      {% endif %}
      {% if card.mode == 'delivery' %}
        <a role="menuitem" href="{% url 'delivery:orders_page' card.id %}">Pedidos (Delivery)</a>
      {% endif %}
    </div>
  </details>
</section>
<div id="publish-modal"></div>
