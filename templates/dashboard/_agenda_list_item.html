{% load currency %}
<li class="node" role="listitem" id="appt-{{ it.id }}" data-day="{{ it.day_iso }}" data-appt-id="{{ it.id }}" data-start="{{ it.start_iso }}">
  <div class="card appt" data-status="{{ it.status }}" data-action-needed="{{ it.reschedule_action_needed|yesno:'true,false' }}" hx-get="{% url 'dashboard:agenda_event_sidebar' it.id %}" hx-target="#agenda-sidebar" hx-swap="innerHTML" hx-trigger="click keyup[key=='Enter']" role="button" tabindex="0" style="cursor:pointer;">
    <div class="row" style="align-items:center;gap:12px;flex-wrap:wrap;">
      <div class="time">{{ it.start_label }}–{{ it.end_label }} • {{ it.duration_min }}min</div>
      <div class="row" style="gap:6px;align-items:center;">
        <span class="status-indicator" style="margin-left:0" title="{{ it.status_label }}">
          <span class="status-dot" data-status="{{ it.status }}" aria-hidden="true"></span>
        </span>
        {% if it.reschedule_action_needed %}
          <span class="badge warning" data-role="reschedule-badge">Ação necessária</span>
        {% elif it.reschedule_latest_status %}
          <span class="badge neutral" data-role="reschedule-badge">{{ it.reschedule_latest_label }}</span>
        {% endif %}
      </div>
    </div>
    {% if it.reschedule_action_needed and it.reschedule_pending_requested_label %}
      <p class="muted" data-role="reschedule-note">Pedido: {{ it.reschedule_pending_requested_label }}</p>
    {% endif %}
    <div class="title">{{ it.customer_name }}{% if it.phone %} <span class="muted">({{ it.phone }})</span>{% endif %}</div>
    <div style="margin-top:var(--space-2)">
      {{ it.service_name }} • @{{ it.card_nick }} • {{ it.channel_label }}{% if it.address_or_link %} • {{ it.address_or_link }}{% endif %} • {{ it.price_cents|brl_cents }}
    </div>
    {% if it.options %}
      <ul class="muted" style="margin:6px 0 0;font-size:12px;padding-left:18px;list-style:disc">
        {% for opt in it.options %}
          <li>
            {{ opt.name }}
            {% if opt.extra_duration_minutes %} · +{{ opt.extra_duration_minutes }} min{% endif %}
            {% if opt.price_delta_cents %}
              · {% if opt.delta_sign >= 0 %}+{% else %}-{% endif %}{{ opt.delta_abs|brl_cents }}
            {% endif %}
            {% if opt.description %} <span class="muted" style="font-style:italic">{{ opt.description }}</span>{% endif %}
          </li>
        {% endfor %}
      </ul>
    {% endif %}
  </div>
</li>
