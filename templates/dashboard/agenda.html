{% extends "base.html" %}
{% block title %}Agenda{% endblock %}
{% block head %}
  {% load static %}
  <style>
    :root{--slot-h:56px}
    .agenda{display:grid;grid-template-columns:280px 1fr;gap:24px;min-height:0}
    .agenda-top{grid-column:1/-1;display:flex;justify-content:space-between;align-items:center;padding:16px 0}
    .agenda-side{background:var(--bg-elev);border:1px solid var(--border);border-radius:12px;padding:16px}
    .agenda-main{position:relative;overflow:auto;border:1px solid var(--border);border-radius:12px}
    .week-grid{display:grid;grid-template-columns:60px 1fr;min-height:calc(24*var(--slot-h))}
    .hours-col{border-right:1px solid var(--border)}
    .hours-col div{height:calc(2*var(--slot-h));padding-right:6px;text-align:right;color:var(--fg-muted);font-size:12px}
    .days-cols{position:relative}
    .events-layer{display:grid;grid-template-columns:repeat(7, 1fr);grid-template-rows:repeat(48, var(--slot-h));position:relative}
    /* Now line visual */
    #now-line{position:absolute;left:0;right:0;height:2px;background:var(--accent);opacity:.75;pointer-events:none}
    .event{background:#fff;border:1px solid var(--border);border-radius:10px;padding:10px;box-shadow:var(--shadow);cursor:pointer;overflow:hidden}
    .event.pending{border-style:dashed}
    .event.confirmed{background:#f2f3f4}
    .event.denied{opacity:.55;text-decoration:line-through}
    /* Sidebar (slideover) for event details */
    .slideover{position:fixed;inset:0 0 0 auto;width:min(420px,100%);background:var(--bg);border-left:1px solid var(--border);box-shadow:var(--shadow);padding:var(--space-4);z-index:1000;display:flex;flex-direction:column;gap:12px}
    .slideover header{display:flex;justify-content:space-between;align-items:center}
    .slideover .body{flex:1;overflow:auto}
    .slideover .actions{display:flex;gap:12px;justify-content:flex-start}
    #agenda-sidebar{position:relative;z-index:150;}
    /* Responsive: stack sections on mobile, default to day view via JS */
    @media (max-width:1024px){
      .agenda{grid-template-columns:1fr}
      .agenda-top{flex-direction:column;align-items:stretch;gap:12px}
    }
  </style>
  {% if view == 'list' %}
  <style>
    /* Timeline (list) styles */
    /* Override grid layout from generic agenda shell when in list mode */
    #agenda-page[data-view="list"] { display:block; }
    /* :root{--bg:#fff;--fg:#111;--muted:#666;--border:#e6e6e8;--elev:#f6f7f8;--shadow:0 1px 2px rgba(0,0,0,.06),0 8px 24px rgba(0,0,0,.08);--r:14px} */
    .bar{display:flex;flex-direction: column; gap:12px;margin-bottom:16px}
    .toggle{display:flex;gap:8px;align-items:center}
    .toggle .btn{border:1px solid var(--border);background:#fff;border-radius:12px;padding:8px 12px}
    .toggle .btn.primary{background:#111;color:#fff;border-color:#111}
    .card{border:1px solid var(--border);border-radius:var(--r);background:var(--bg);box-shadow:var(--shadow);padding:12px}
    .timeline{position:relative}
    /* .day.sticky{position:sticky;top:0;background:var(--bg);padding:8px 0;margin:12px 0 8px;border-bottom:1px solid var(--border)} */
    .col{position:relative;margin:0;padding:0 0 0 28px;list-style:none}
    .node{position:relative;margin:10px 0}
    .dot{position:absolute;left:8px;top:18px;width:10px;height:10px;border-radius:50%;background:#111}
    .line{position:absolute;left:12px;top:0;bottom:0;width:2px;background:var(--border)}
    .card .row{display:flex;gap:8px;justify-content:space-between;align-items:center}
    .badge{border:1px solid var(--border);border-radius:999px;padding:2px 8px;color:var(--muted);font-size:.85rem}
    .badge.confirmed{border-color:#111;color:#111}
    .badge.warning{border-color:var(--accent);color:var(--accent);}
    .badge.neutral{border-color:var(--border);color:var(--fg-muted);}
    .muted{color:var(--muted)}
    .actions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
    .is-hidden{display:none !important}
    .day-group{margin-bottom:20px;}
    .day-group h3{margin-bottom:8px;}
    [data-role="reschedule-note"]{font-size:0.85rem;}
    @media(max-width:720px){ 
        aside .row{flex-direction:row;align-items:flex-start} 
        .agenda .row{flex-direction:row;align-items:flex-start}
        .bar{flex-direction:column;align-items:stretch}
        .input, .select, .textarea {width: 100%;}
        #filters {width: 100%;}
        .card .row{display: flex;flex-direction: row;}
        section .col{padding-left: 0;}
      }
  </style>
  {% endif %}
{% endblock %}
{% block breadcrumb %}Agenda{% endblock %}
{% block content %}
<section id="agenda-page" class="agenda" data-view="{{ view }}">
  {% if view == 'list' %}
  <header class="bar">

    <div class="toggle" role="tablist" aria-label="Alternar visualização">
      <a href="{% url 'dashboard:agenda' %}?view=week" class="btn" role="tab" aria-selected="false">Calendário</a>
      <a href="{% url 'dashboard:agenda' %}?view=list" class="btn primary" role="tab" aria-selected="true">Lista</a>
      <button type="button" id="filters-btn" class="btn ghost" title="Mostrar/ocultar filtros" aria-label="Mostrar ou ocultar filtros" aria-controls="filters" aria-expanded="{% if request.GET.status or request.GET.name or request.GET.contact or request.GET.start or request.GET.end or request.GET.needs_action %}true{% else %}false{% endif %}">
        <svg aria-hidden="true" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12 10 19 14 21 14 12 22 3"/></svg>
      </button>
    </div>
    <div class="row" style="gap:8px;align-items:center;">
      {% if reschedule_pending_count %}
        <span class="badge warning" data-role="pending-counter" aria-live="polite">Pendências: {{ reschedule_pending_count }}</span>
      {% else %}
        <span class="badge neutral" data-role="pending-counter" aria-live="polite">Sem pendências</span>
      {% endif %}
    </div>
    <div class="row">
    <form id="filters" class="row{% if not request.GET.status and not request.GET.name and not request.GET.contact and not request.GET.start and not request.GET.end and not request.GET.needs_action %} is-hidden{% endif %}" role="search" aria-label="Filtros de agenda"
          hx-get="{% url 'dashboard:agenda_list_partial' %}"
          hx-trigger="submit"
          hx-target="#list" hx-swap="innerHTML" hx-push-url="true">
      <select name="status" class="select">
        <option value="">Todos</option>
        <option value="pending" {% if request.GET.status == 'pending' %}selected{% endif %}>Pendentes</option>
        <option value="confirmed" {% if request.GET.status == 'confirmed' %}selected{% endif %}>Confirmados</option>
        <option value="denied" {% if request.GET.status == 'denied' %}selected{% endif %}>Negados</option>
        <option value="cancelled" {% if request.GET.status == 'cancelled' %}selected{% endif %}>Cancelados</option>
      </select>
      <label class="row" style="gap:6px;align-items:center;">
        <input type="checkbox" name="needs_action" value="1" {% if request.GET.needs_action %}checked{% endif %}>
        <span>Com ação pendente</span>
      </label>
      <!-- <input type="search" name="name" class="input" placeholder="Nome ou @nick" value="{{ request.GET.name }}" aria-label="Nome ou nickname" /> -->
      <input type="search" name="contact" class="input" placeholder="Telefone ou e‑mail (somente confirmados)" value="{{ request.GET.contact }}" aria-label="Contato" />
      <input type="date" name="start" class="input" value="{{ request.GET.start }}" aria-label="Início" />
      <input type="date" name="end" class="input" value="{{ request.GET.end }}" aria-label="Fim" />
      <button type="submit" class="btn">Filtrar</button>
    </form>
    </div>
  </header>
  <div id="list" hx-get="{% url 'dashboard:agenda_list_partial' %}{% if request.GET %}?{{ request.GET.urlencode }}{% else %}?view=list{% endif %}"
       hx-trigger="load" hx-swap="innerHTML">
    <div class="card" role="status" aria-live="polite">Carregando…</div>
  </div>
  <aside id="agenda-sidebar" aria-live="polite"></aside>
  {% else %}
  <header class="agenda-top">
    <div class="row" >
      <div class="toggle" role="tablist" aria-label="Alternar visualização">
        <a href="{% url 'dashboard:agenda' %}?view=week" class="btn primary" role="tab" aria-selected="false">Calendário</a>
        <a href="{% url 'dashboard:agenda' %}?view=list" class="btn" role="tab" aria-selected="true">Lista</a>
      </div>
      <div class="row" style="gap:8px;align-items:center;">
        {% if reschedule_pending_count %}
          <span class="badge warning" data-role="pending-counter" aria-live="polite">Pendências: {{ reschedule_pending_count }}</span>
        {% else %}
          <span class="badge neutral" data-role="pending-counter" aria-live="polite">Sem pendências</span>
        {% endif %}
      </div>
    </div>
    <div class="row">
      <button class="btn" hx-get="{% url 'dashboard:agenda' %}?view={{ view }}&date={{ prev }}" hx-target="#agenda-page" hx-swap="outerHTML" hx-select="#agenda-page">◀</button>
      <button class="btn" hx-get="{% url 'dashboard:agenda' %}?view={{ view }}&date={{ today }}" hx-target="#agenda-page" hx-swap="outerHTML" hx-select="#agenda-page">Hoje</button>
      <button class="btn" hx-get="{% url 'dashboard:agenda' %}?view={{ view }}&date={{ next }}" hx-target="#agenda-page" hx-swap="outerHTML" hx-select="#agenda-page">▶</button>
      <strong style="margin-left:8px">{{ header_range_label }}</strong>
    </div>
    <div class="row">
      <select class="select" name="view" hx-trigger="change" hx-get="{% url 'dashboard:agenda' %}?date={{ anchor }}" hx-target="#agenda-page" hx-swap="outerHTML" hx-select="#agenda-page">
        <option value="list" {% if view == 'list' %}selected{% endif %}>Lista</option>
        <option value="day" {% if view == 'day' %}selected{% endif %}>Dia</option>
        <option value="week" {% if view == 'week' %}selected{% endif %}>Semana</option>
        <option value="month" {% if view == 'month' %}selected{% endif %}>Mês</option>
      </select>
      <span class="muted">Fuso: {{ tz_label }}</span>
    </div>
  </header>

  <aside class="agenda-side">
    <div id="filters">
      <label class="muted">Status</label>
      <select class="select" name="status"
              hx-get="{% url 'dashboard:agenda' %}"
              hx-vals='{"view":"{{ view }}","date":"{{ anchor }}"}'
              hx-target="#agenda-page" hx-swap="outerHTML" hx-select="#agenda-page">
        <option value="" {% if not request.GET.status %}selected{% endif %}>Todos</option>
        <option value="pending" {% if request.GET.status == 'pending' %}selected{% endif %}>Pendentes</option>
        <option value="confirmed" {% if request.GET.status == 'confirmed' %}selected{% endif %}>Confirmados</option>
        <option value="denied" {% if request.GET.status == 'denied' %}selected{% endif %}>Negados</option>
      </select>
    </div>
  </aside>

  <div id="agenda-root" class="agenda-main">
    {% if view == 'month' %}
      <div class="card" style="border:0;background:transparent">
        <div class="row" style="gap:12px; padding:8px 12px; border-bottom:1px solid var(--border); justify-content:space-between">
          <div style="flex:1; text-align:center" class="muted">SEG</div>
          <div style="flex:1; text-align:center" class="muted">TER</div>
          <div style="flex:1; text-align:center" class="muted">QUA</div>
          <div style="flex:1; text-align:center" class="muted">QUI</div>
          <div style="flex:1; text-align:center" class="muted">SEX</div>
          <div style="flex:1; text-align:center" class="muted">SAB</div>
          <div style="flex:1; text-align:center" class="muted">DOM</div>
        </div>
        <div class="grid" style="grid-template-columns:repeat(7,1fr); gap:1px; background:var(--border)">
          {% for week in month_weeks %}
            {% for d in week %}
              <div style="min-height:120px;background:var(--bg);padding:8px">
                <div class="muted" style="font-size:12px;opacity:{% if d.in_month %}1{% else %}.5{% endif %}">{{ d.label }}</div>
                {% if d.events %}
                  <div class="grid" style="gap:6px;margin-top:6px">
                    {% for ev in d.events %}
                      <div class="row" style="gap:6px;align-items:center">
                        <span class="pill" style="padding:2px 6px;font-size:11px">{{ ev.time }}</span>
                        <span style="font-size:12px">{{ ev.service }}</span>
                      </div>
                    {% endfor %}
                  </div>
                {% endif %}
              </div>
            {% endfor %}
          {% endfor %}
        </div>
      </div>
    {% else %}
      <div class="week-grid"
           hx-get="{% url 'dashboard:agenda_events' %}?start={{ range_start_iso|urlencode }}&end={{ range_end_iso|urlencode }}&view={{ view }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}"
           hx-trigger="load, agenda:refresh from:body"
           hx-target="#events-layer" hx-swap="innerHTML">
        <div class="hours-col">
          {% for h in hours %}
            <div>{{ h }}:00</div>
          {% endfor %}
        </div>
        <div class="days-cols">
          <div class="row" style="gap:12px; padding:8px 12px; border-bottom:1px solid var(--border); justify-content:space-between">
            {% for d in days %}
              <div style="flex:1; text-align:center" class="muted">{{ d.label }}</div>
            {% endfor %}
          </div>
          <div id="events-layer" class="events-layer" style="grid-template-columns:repeat({{ days|length }}, 1fr)"><!-- events --></div>
        </div>
      </div>
    {% endif %}
  </div>

  <aside id="agenda-sidebar" aria-live="polite"></aside>
  {% endif %}
</section>

<script>
  (function(){
    try{
      var isMobile = window.matchMedia('(max-width: 1024px)').matches;
      var currentView = '{{ view }}';
      if(isMobile && currentView !== 'day' && currentView !== 'list'){
        var url = '{% url 'dashboard:agenda' %}?view=day&date={{ anchor }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}';
        htmx.ajax('GET', url, { target: '#agenda-page', swap: 'outerHTML' });
      }
    }catch(_){ }
  })();

  (function(){
    var filters = document.getElementById('filters');
    var toggleBtn = document.getElementById('filters-btn');
    if(!filters || !toggleBtn){ return; }
    function setFilters(open){
      if(open){
        filters.classList.remove('is-hidden');
        filters.style.display = '';
        toggleBtn.setAttribute('aria-expanded', 'true');
      } else {
        filters.classList.add('is-hidden');
        filters.style.display = 'none';
        toggleBtn.setAttribute('aria-expanded', 'false');
      }
      try{ localStorage.setItem('agendaFiltersOpen', open ? '1' : '0'); }catch(_){ }
    }
    toggleBtn.addEventListener('click', function(ev){
      ev.preventDefault();
      var open = !filters.classList.contains('is-hidden') && filters.style.display !== 'none';
      setFilters(!open);
    });
    document.addEventListener('DOMContentLoaded', function(){
      try{
        var pref = localStorage.getItem('agendaFiltersOpen');
        if(pref !== null){ setFilters(pref === '1'); }
      }catch(_){ }
    });
  })();

  (function(){
    function updateDayHeader(group){
      if(!group){ return; }
      var list = group.querySelector('ol');
      var heading = group.querySelector('h3');
      if(!list || !heading){ return; }
      var count = list.querySelectorAll('li.node').length;
      if(count === 0){
        group.remove();
        return;
      }
      var label = heading.getAttribute('data-label') || heading.textContent.split(' • ')[0];
      heading.setAttribute('data-label', label);
      heading.textContent = label + ' • ' + count + (count === 1 ? ' agendamento' : ' agendamentos');
    }

    function insertSorted(container, item){
      var inserted = false;
      var newStart = item.dataset.start || '';
      Array.prototype.forEach.call(container.querySelectorAll('li.node'), function(existing){
        if(inserted){ return; }
        var existingStart = existing.dataset.start || '';
        if(newStart && existingStart && newStart < existingStart){
          existing.before(item);
          inserted = true;
        }
      });
      if(!inserted){
        container.appendChild(item);
      }
    }

    document.body.addEventListener('agenda:item-updated', function(ev){
      var detail = ev.detail || {};
      var listRoot = document.getElementById('list');
      if(!listRoot || !detail.id || !detail.html){ return; }
      var template = document.createElement('template');
      template.innerHTML = detail.html.trim();
      var newItem = template.content.firstElementChild;
      if(!newItem){ return; }
      var newDay = detail.new_day || detail.newDay;
      var oldDay = detail.old_day || detail.oldDay;
      var existing = document.getElementById('appt-' + detail.id);
      if(existing && (!newDay || existing.dataset.day !== newDay)){
        existing.remove();
      }
      var targetList = newDay ? document.querySelector('.day-group[data-day="' + newDay + '"] ol') : null;
      if(!targetList){
        var url = listRoot.getAttribute('hx-get');
        if(url){
          htmx.ajax('GET', url, { target: '#list', swap: 'innerHTML' });
        }
        return;
      }
      var targetGroup = targetList.closest('.day-group');
      var current = document.getElementById('appt-' + detail.id);
      if(current && current.parentElement === targetList){
        current.replaceWith(newItem);
      } else {
        insertSorted(targetList, newItem);
      }
      updateDayHeader(targetGroup);
      if(oldDay && oldDay !== newDay){
        var oldGroup = document.querySelector('.day-group[data-day="' + oldDay + '"]');
        if(oldGroup){
          var oldList = oldGroup.querySelector('ol');
          if(oldList){
            var oldItem = oldList.querySelector('#appt-' + detail.id);
            if(oldItem){ oldItem.remove(); }
          }
          updateDayHeader(oldGroup);
        }
      }
    });

    document.body.addEventListener('agenda:pending-count', function(ev){
      var count = ev.detail;
      if(typeof count !== 'number'){ count = parseInt(count || '0', 10); }
      if(isNaN(count)){ count = 0; }
      document.querySelectorAll('[data-role="pending-counter"]').forEach(function(el){
        if(count > 0){
          el.textContent = 'Pendências: ' + count;
          el.classList.remove('neutral');
          el.classList.add('warning');
        } else {
          el.textContent = 'Sem pendências';
          el.classList.remove('warning');
          el.classList.add('neutral');
        }
      });
    });
  })();
</script>
{% endblock %}
