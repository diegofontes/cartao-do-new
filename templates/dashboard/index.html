{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<style>
  :root{
    --g2: 12px; --g3: 16px; --g4: 24px; --g5: 32px;
  }
  .kpis{display:grid; gap:var(--g3); grid-template-columns:repeat(auto-fit,minmax(220px,1fr));}
  .badge{border:1px solid var(--border); border-radius:999px; padding:2px 8px; color:var(--muted);}
  .table{width:100%; border-collapse:separate; border-spacing:0; min-width:720px;}
  .table-wrap{overflow-x:auto; -webkit-overflow-scrolling:touch}
  .table th,.table td{padding:10px 12px; border-bottom:1px solid var(--border);}  
  /* visually hide the native month input but keep it functional for HTMX */
  .visually-hidden{position:absolute !important; width:1px !important; height:1px !important; padding:0 !important; margin:-1px !important; overflow:hidden !important; clip:rect(0,0,0,0) !important; white-space:nowrap !important; border:0 !important; opacity:0 !important; pointer-events:none !important;}
  .period-btn{display:inline-flex; align-items:center; gap:8px}
</style>

<section>
  <div id="jornal-news-card-placeholder"
       hx-get="{% url 'jornal:news' %}"
       hx-trigger="load"
       hx-swap="outerHTML">
    <article class="card jornal-news-card">
      <header class="jornal-news-card__header">
        <div>
          <h2>Quadro de Notícias</h2>
          <p class="muted">Carregando novidades…</p>
        </div>
      </header>
      <p class="muted">Aguarde enquanto buscamos atualizações.</p>
    </article>
  </div>
  <header style="margin-bottom:var(--g4);margin-top:var(--g4);">
    <h1>Resumo de Uso & Cobrança</h1>
    <div class="filters" style="display:flex; gap:8px; align-items:center">
      <input class="visually-hidden" type="month" id="period" name="period" value="{{ current_month }}"
             hx-get="{% url 'billing:kpis' %}"
             hx-include="#period"
             hx-target="#kpis" hx-swap="outerHTML">
      <button class="btn" id="period-prev" type="button" aria-label="Mês anterior">◀</button>
      <button class="btn period-btn" id="period-btn" type="button" aria-controls="period" aria-label="Selecionar período">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <rect x="3" y="5" width="18" height="16" rx="2" stroke="currentColor" stroke-width="1.5"/>
          <path d="M8 3V7M16 3V7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
          <path d="M3 9H21" stroke="currentColor" stroke-width="1.5"/>
        </svg>
        <span id="period-label">{{ current_month }}</span>
      </button>
      <button class="btn" id="period-next" type="button" aria-label="Próximo mês">▶</button>
    </div>
  </header>

  <div id="kpis" class="kpis"
       hx-get="{% url 'billing:kpis' %}?start={{ period_start }}&end={{ period_end }}"
       hx-trigger="load" hx-include="#period" hx-swap="outerHTML">
    <div class="card">Carregando KPIs…</div>
  </div>
  <script>
    (function(){
      const input = document.getElementById('period');
      const btn = document.getElementById('period-btn');
      const prev = document.getElementById('period-prev');
      const next = document.getElementById('period-next');
      const label = document.getElementById('period-label');
      if (!input || !btn || !label) return;
      function fmt(val){
        // expects YYYY-MM, renders MM/YYYY
        if (!val || val.length < 7 || val[4] !== '-') return val || '';
        return val.slice(5,7) + '/' + val.slice(0,4);
      }
      function updateLabel(){ label.textContent = fmt(input.value); }
      updateLabel();
      input.addEventListener('change', updateLabel);
      input.addEventListener('input', updateLabel);
      function triggerChange(){
        // Fire both input and change to satisfy htmx triggers
        input.dispatchEvent(new Event('input', {bubbles:true}));
        input.dispatchEvent(new Event('change', {bubbles:true}));
      }
      if (prev) prev.addEventListener('click', function(){
        try { input.stepDown(); } catch(e) {}
        updateLabel();
        triggerChange();
      });
      if (next) next.addEventListener('click', function(){
        try { input.stepUp(); } catch(e) {}
        updateLabel();
        triggerChange();
      });
      btn.addEventListener('click', function(){
        if (typeof input.showPicker === 'function'){
          try { input.showPicker(); return; } catch(e){}
        }
        // Fallbacks to try opening native picker
        try { input.focus(); input.click(); } catch(e){}
      });
    })();
  </script>

  <div class="card" style="margin-top:var(--g4);">
    <h2>Prévia de cobrança</h2>
    <div class="table-wrap" role="region" aria-label="Prévia de cobrança rolável">
      <div id="preview"
           hx-get="{% url 'billing:preview' %}?start={{ period_start }}&end={{ period_end }}"
           hx-trigger="load from:#period changed"
           hx-include="#period"
           hx-swap="innerHTML">Calculando…</div>
    </div>
  </div>

  <!-- <div class="card" style="margin-top:var(--g4);">
    <div class="row" style="display:flex;justify-content:space-between;align-items:center;">
      <h2>Eventos recentes</h2>
      <form hx-get="{% url 'metering:events' %}" hx-target="#events" hx-swap="outerHTML" hx-include="#period">
        <select name="type" class="select">
          <option value="">Todos</option>
          <option value="publish">Publicação</option>
          <option value="appointment_confirmed">Agendamento confirmado</option>
          <option value="link_add">Link adicionado</option>
          <option value="gallery_add">Item de galeria</option>
        </select>
        <button class="btn">Filtrar</button>
      </form>
    </div>
    <div class="table-wrap" role="region" aria-label="Eventos recentes rolável">
      <div id="events" hx-get="{% url 'metering:events' %}" hx-trigger="load from:#period changed" hx-include="#period" hx-swap="outerHTML">Carregando…</div>
    </div>
  </div> -->

  <!-- <div class="card" style="margin-top:var(--g4);">
    <h2>Checagens de integridade</h2>
    <button class="btn"
            hx-post="{% url 'billing:self_checks' %}"
            hx-include="#period"
            hx-target="#checks" hx-swap="outerHTML">Rodar checagens</button>
    <div class="table-wrap" role="region" aria-label="Checagens de integridade rolável">
      <div id="checks" class="help">Clique para validar o metering.</div>
    </div>
  </div> -->

  <div class="card" style="margin-top:var(--g4);">
    <h2>Pagamentos realizados</h2>
    <div>
      {% for inv in paid_invoices %}
        <div class="row" style="justify-content:space-between;padding:10px 0;border-top:1px solid var(--border)">
          <div>
            <div class="font-medium">{{ inv.period_start }} — {{ inv.period_end }}</div>
            <div class="muted">Status: {{ inv.status }}</div>
          </div>
          <div style="text-align:right">
            <!-- <div class="font-medium">{{ inv.amount_cents }}</div> -->
            {% if inv.hosted_invoice_url %}
              <a class="muted" href="{{ inv.hosted_invoice_url }}" target="_blank" rel="noopener">Ver no Stripe</a>
            {% endif %}
          </div>
        </div>
      {% empty %}
        <div class="muted">Nenhum pagamento realizado ainda.</div>
      {% endfor %}
    </div>
  </div>
</section>
{% endblock %}
