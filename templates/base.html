{% load django_htmx %}
{% load static %}
<!doctype html>
<html lang="pt-BR" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{% block title %}Pay-as-you-go Demo{% endblock %}</title>
    <!-- Optional Tailwind output (se estiver usando) -->
    <link rel="stylesheet" href="{% static 'css/dist/styles.css' %}">
    <!-- UI grayscale stylesheet -->
    <link rel="stylesheet" href="{% static 'ui/styles.css' %}">
    <!-- HTMX (via django-htmx helper) -->
    {% htmx_script %}
    <!-- Theme + HTMX CSRF helper (lê csrftoken do cookie) -->
    <script defer src="{% static 'ui/theme.js' %}"></script>
    {% block head %}{% endblock %}
  </head>
  <body >
    <a class="skip-link" href="#main">Pular para conteúdo</a>
    <div class="layout">
      <aside class="sidebar" aria-label="Barra lateral" aria-hidden="false">
        <div class="logo">
          <img id="logo"
               src="{% static 'img/logo-cap-v1-dark.png' %}"
               data-logo-light="{% static 'img/logo-cap-v1-dark.png' %}"
               data-logo-dark="{% static 'img/logo-cap-v1.png' %}"
               alt="Paygo" />
          <!-- Close button only on mobile, aligned to the opposite corner -->
          <button type="button" class="btn hamburger mobile-viewer" aria-label="Fechar menu" data-close-drawer title="Fechar">
            <svg aria-hidden="true" width="18" height="18"><use href="{% static 'ui/icons.svg' %}#icon-x"></use></svg>
          </button>
        </div>
        <nav>
          <a class="nav-item" href="{% url 'dashboard:index' %}">
            <svg aria-hidden="true" width="18" height="18"><use href="{% static 'ui/icons.svg' %}#icon-home"></use></svg>
            <span class="nav-label">Dashboard</span>
          </a>
          <a class="nav-item" href="{% url 'cards:list' %}">
            <svg aria-hidden="true" width="18" height="18"><use href="{% static 'ui/icons.svg' %}#icon-cards"></use></svg>
            <span class="nav-label">Cartões</span>
          </a>
          <a class="nav-item" href="{% url 'dashboard:agenda' %}">
            <svg aria-hidden="true" width="18" height="18"><use href="{% static 'ui/icons.svg' %}#icon-calendar"></use></svg>
            <span class="nav-label">Agenda</span>
          </a>
          <a class="nav-item" href="{% url 'billing:payment_method' %}">
            <svg aria-hidden="true" width="18" height="18"><use href="{% static 'ui/icons.svg' %}#icon-table"></use></svg>
            <span class="nav-label">Pagamento</span>
          </a>
        </nav>
        <div class="footer" role="contentinfo">v0.1.0</div>
      </aside>
      <!-- <div class="drawer-backdrop" role="presentation"></div> -->
      <div class="main">
        <header class="topbar" role="banner">
          <div class="topbar-inner">
            <button type="button" class="btn hamburger mobile-viewer" aria-label="Abrir menu mobile" data-open-drawer  >☰</button>
            <button type="button" class="btn hamburger desktop-viewer" aria-label="Abrir menu desktop" data-toggle-sidebar >☰</button>
            <nav aria-label="Breadcrumb" class="row" style="flex:1">
              <a href="{% url 'dashboard:index' %}">Início</a>
              <span class="muted">/</span>
              <strong>{% block breadcrumb %}Dashboard{% endblock %}</strong>
            </nav>
            <!-- <form class="row" role="search" aria-label="Busca global" hx-get="/search" hx-target="#results" hx-push-url="true">
              <svg aria-hidden="true" width="18" height="18"><use href="{% static 'ui/icons.svg' %}#icon-search"></use></svg>
              <input name="q" class="input" placeholder="Buscar" aria-label="Buscar" />
              <div id="spinner" class="spinner htmx-indicator" aria-hidden="true"></div>
            </form> -->
            <button type="button" class="btn ghost" aria-label="Alternar tema" data-toggle-theme onclick="toggleTheme()">
              <svg aria-hidden="true" width="18" height="18"><use href="{% static 'ui/icons.svg' %}#icon-moon"></use></svg>
            </button>
            {% if user.is_authenticated %}
            <form method="post" action="logout/" class="inline">
              {% csrf_token %}
              <button type="submit" class="btn">Sair</button>
            </form>
            {% else %}
            <a class="btn" href="{% url 'accounts:auth_login' %}">Entrar</a>
            {% endif %}
          </div>
        </header>
        <main id="main" class="container">
          {% block content %}{% endblock %}
        </main>
      </div>
    </div>
    <div id="toasts" class="toasts" aria-live="polite" aria-atomic="true"></div>
    <script>
      // Fallback: garante função global se static/ui/theme.js não carregar
      if (typeof window.toggleTheme !== 'function') {
        (function(){
          function applyLogoFor(theme){
            try{
              var el = document.getElementById('logo');
              if(!el) return;
              var light = el.getAttribute('data-logo-light');
              var dark = el.getAttribute('data-logo-dark');
              el.src = theme === 'dark' ? (dark || el.src) : (light || el.src);
            }catch(e){}
          }
          window.toggleTheme = function(){
            var root = document.documentElement;
            var next = (root.getAttribute('data-theme') === 'dark') ? 'light' : 'dark';
            root.setAttribute('data-theme', next);
            try{ localStorage.setItem('theme', next); }catch(e){}
            applyLogoFor(next);
          };
          // Ajusta o logo na carga inicial
          document.addEventListener('DOMContentLoaded', function(){
            var current = document.documentElement.getAttribute('data-theme') || 'light';
            applyLogoFor(current);
          });
          // Clique delegado para elementos com data-toggle-theme
          document.addEventListener('click', function(e){
            var t = e.target.closest('[data-toggle-theme]');
            if(t){ e.preventDefault(); try{ window.toggleTheme(); }catch(_){} }
          });
        })();
      }
    </script>
  </body>
</html>
