{% load django_htmx %}
{% load static %}
<!doctype html>
<html lang="pt-BR" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{% block title %}Cartão DO{% endblock %}</title>
    <!-- Optional Tailwind output (se estiver usando) -->
    <link rel="stylesheet" href="{% static 'css/dist/styles.css' %}">
    <!-- UI grayscale stylesheet -->
    <link rel="stylesheet" href="{% static 'ui/styles.css' %}">
    <!-- EasyMDE (Markdown editor) -->
    <link rel="stylesheet" href="https://unpkg.com/easymde/dist/easymde.min.css">
    <!-- HTMX (via django-htmx helper) -->
     
    {% htmx_script %}
    <!-- Theme + HTMX CSRF helper (lê csrftoken do cookie) -->
    <script defer src="{% static 'ui/theme.js' %}"></script>
    <!-- Dashboard helpers (agenda sizing/scroll) -->
    <script defer src="{% static 'ui/dashboard.js' %}"></script>
    {% block head %}{% endblock %}
  </head>
  <body >
    <a class="skip-link" href="#main">Pular para conteúdo</a>
    <div class="layout">
      <aside class="sidebar" aria-label="Barra lateral" aria-hidden="false">
        <div class="logo">
          <img id="logo"
               src="{% static 'img/logo-cap-v1-dark.png' %}"
               data-logo-light="{% static 'img/logo-cap-v1-dark.png' %}"
               data-logo-dark="{% static 'img/logo-cap-v1.png' %}"
               alt="Paygo" />
          <!-- Close button only on mobile, aligned to the opposite corner -->
          <button type="button" class="btn hamburger mobile-viewer" aria-label="Fechar menu" data-close-drawer title="Fechar">
            <svg aria-hidden="true" width="18" height="18"><use href="{% static 'ui/icons.svg' %}#icon-x"></use></svg>
          </button>
        </div>
        <nav>
          <a class="nav-item" href="{% url 'dashboard:index' %}">
            <svg aria-hidden="true" width="18" height="18"><use href="{% static 'ui/icons.svg' %}#icon-home"></use></svg>
            <span class="nav-label">Dashboard</span>
          </a>
          <a class="nav-item" href="{% url 'cards:list' %}">
            <svg aria-hidden="true" width="18" height="18"><use href="{% static 'ui/icons.svg' %}#icon-cards"></use></svg>
            <span class="nav-label">Cartões</span>
          </a>
          <a class="nav-item" href="{% url 'dashboard:agenda' %}">
            <svg aria-hidden="true" width="18" height="18"><use href="{% static 'ui/icons.svg' %}#icon-calendar"></use></svg>
            <span class="nav-label">Agenda</span>
          </a>
          <a class="nav-item" href="{% url 'billing:payment_method' %}">
            <svg aria-hidden="true" width="18" height="18"><use href="{% static 'ui/icons.svg' %}#icon-table"></use></svg>
            <span class="nav-label">Pagamento</span>
          </a>
        </nav>
        <div class="footer" role="contentinfo">Cartão DO</div>
      </aside>
      <!-- <div class="drawer-backdrop" role="presentation"></div> -->
      <div class="main">
        <header class="topbar" role="banner">
          <div class="topbar-inner">
            <button type="button" class="btn hamburger mobile-viewer" aria-label="Abrir menu mobile" data-open-drawer  >☰</button>
            <button type="button" class="btn hamburger desktop-viewer" aria-label="Abrir menu desktop" data-toggle-sidebar >☰</button>
            <nav aria-label="Breadcrumb" class="row" style="flex:1">
              <a href="{% url 'dashboard:index' %}">Início</a>
              <span class="muted">/</span>
              <strong>{% block breadcrumb %}Dashboard{% endblock %}</strong>
            </nav>
            <!-- <form class="row" role="search" aria-label="Busca global" hx-get="/search" hx-target="#results" hx-push-url="true">
              <svg aria-hidden="true" width="18" height="18"><use href="{% static 'ui/icons.svg' %}#icon-search"></use></svg>
              <input name="q" class="input" placeholder="Buscar" aria-label="Buscar" />
              <div id="spinner" class="spinner htmx-indicator" aria-hidden="true"></div>
            </form> -->
            <button type="button" class="btn ghost" aria-label="Alternar tema" data-toggle-theme onclick="toggleTheme()">
              <svg aria-hidden="true" width="18" height="18"><use href="{% static 'ui/icons.svg' %}#icon-moon"></use></svg>
            </button>
            {% if user.is_authenticated %}
            <form method="post" action="{% url 'logout' %}" class="inline">
              {% csrf_token %}
              <button type="submit" class="btn">Sair</button>
            </form>
            {% else %}
            <a class="btn" href="{% url 'accounts:auth_login' %}">Entrar</a>
            {% endif %}
          </div>
        </header>
        <main id="main" class="container">
          {% block content %}{% endblock %}
        </main>
      </div>
    </div>
    

  <div id="load-modal" class="load-modal" aria-hidden="true" aria-live="polite">
    <div class="load-box" role="dialog" aria-modal="true" aria-label="Carregando" tabindex="-1">
      <div class="load-spinner" aria-hidden="true"></div>
      <div class="load-text">Processando...</div>
      <progress id="load-progress" max="100" value="0" hidden></progress>
    </div>
  </div>
  <div id="toasts" class="toasts" aria-live="polite" aria-atomic="true"></div>
  <script>
    (function () {
      const modal = document.getElementById('load-modal');
      const toasts = document.getElementById('toasts');
      if (!modal || !toasts) return;

      const box = modal.querySelector('.load-box');
      const progress = document.getElementById('load-progress');
      const shell = document.querySelector('.layout');
      let pending = 0;
      let restoreFocus = null;
      let previousOverflow = '';

      function getFocusable() {
        return Array.from(
          modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])')
        ).filter((el) => !el.hasAttribute('disabled') && el.getAttribute('aria-hidden') !== 'true');
      }

      modal.addEventListener('keydown', (event) => {
        if (event.key !== 'Tab') return;
        const focusables = getFocusable();
        if (!focusables.length) {
          event.preventDefault();
          box?.focus();
          return;
        }
        const first = focusables[0];
        const last = focusables[focusables.length - 1];
        const active = document.activeElement;
        if (event.shiftKey) {
          if (active === first || active === modal) {
            event.preventDefault();
            last.focus();
          }
        } else if (active === last) {
          event.preventDefault();
          first.focus();
        }
      });

      function shouldSkip(elt) {
        return elt?.closest?.('[data-no-load]') != null;
      }

      function setInert(state) {
        if (!shell) return;
        if (state) shell.setAttribute('inert', '');
        else shell.removeAttribute('inert');
      }

      function openModal(showProgress) {
        if (!modal.classList.contains('is-open')) {
          previousOverflow = document.body.style.overflow;
          modal.classList.add('is-open');
          modal.setAttribute('aria-hidden', 'false');
          document.body.style.overflow = 'hidden';
          setInert(true);
          restoreFocus = document.activeElement instanceof HTMLElement ? document.activeElement : null;
          box?.focus({ preventScroll: true });
        }
        if (progress) {
          progress.value = 0;
          progress.hidden = !showProgress;
        }
      }

      function resetModal() {
        if (!modal.classList.contains('is-open')) return;
        modal.classList.remove('is-open');
        modal.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = previousOverflow || '';
        setInert(false);
        if (progress) {
          progress.hidden = true;
          progress.value = 0;
        }
        if (restoreFocus && typeof restoreFocus.focus === 'function') {
          restoreFocus.focus();
        }
        restoreFocus = null;
      }

      function begin(showProgress) {
        pending += 1;
        openModal(showProgress);
      }

      function finish() {
        pending = Math.max(0, pending - 1);
        if (pending === 0) resetModal();
      }

      function toast({ type = 'ok', title, message }) {
        const el = document.createElement('div');
        const variant = type === 'err' ? 'err' : 'ok';
        el.className = `toast ${variant}`;
        el.setAttribute('role', type === 'err' ? 'alert' : 'status');
        el.innerHTML = `
          <div class="toast-copy">
            <div class="title">${title || (type === 'err' ? 'Não foi possível salvar' : 'Salvo com sucesso')}</div>
            ${message ? `<div class="msg">${message}</div>` : ''}
          </div>
          <button type="button" class="toast-close" aria-label="Fechar aviso">
            <span aria-hidden="true">&times;</span>
          </button>
        `;
        el.querySelector('.toast-close')?.addEventListener('click', () => el.remove());
        toasts.appendChild(el);
        window.setTimeout(() => el.remove(), type === 'err' ? 7000 : 5000);
      }

      function parseFlash(xhr) {
        const headers = ['HX-Trigger', 'HX-Trigger-After-Settle', 'HX-Trigger-After-Response'];
        for (const header of headers) {
          const raw = xhr?.getResponseHeader(header);
          if (!raw) continue;
          try {
            const data = JSON.parse(raw);
            const flash = data.flash || data['flash:after'] || data['flash:response'];
            if (flash) return flash;
          } catch (_) {
            continue;
          }
        }
        return null;
      }

      function showFlash(flash, status) {
        if (!flash) return false;
        const type = flash.type === 'error' ? 'err' : 'ok';
        if (type === 'err' && status >= 400) return false;
        toast({
          type,
          title: flash.title || (type === 'err' ? 'Erro' : 'Sucesso'),
          message: flash.message || ''
        });
        return true;
      }

      document.body.addEventListener('htmx:beforeRequest', (event) => {
        const elt = event.detail?.elt || event.target;
        if (shouldSkip(elt)) return;
        const form = elt?.closest?.('form');
        const encoding = form?.enctype || form?.getAttribute?.('hx-encoding') || '';
        const isUpload = typeof encoding === 'string' && encoding.toLowerCase().includes('multipart/form-data');
        begin(isUpload);
      });

      document.body.addEventListener('htmx:xhr:progress', (event) => {
        if (!progress || progress.hidden) return;
        const { loaded, total, lengthComputable } = event.detail;
        if (!lengthComputable || typeof total !== 'number' || total <= 0) return;
        progress.value = Math.round((loaded / total) * 100);
      });

      document.body.addEventListener('htmx:sendError', () => {
        finish();
        toast({
          type: 'err',
          title: 'Falha de rede',
          message: 'Verifique sua conexão e tente novamente.'
        });
      });

      document.body.addEventListener('htmx:responseError', (event) => {
        const xhr = event.detail?.xhr;
        const status = xhr?.status || 0;
        const flash = parseFlash(xhr);
        if (flash && flash.type === 'error') {
          toast({
            type: 'err',
            title: flash.title || 'Não foi possível concluir',
            message: flash.message || ''
          });
          return;
        }
        let message = 'Não foi possível completar a ação.';
        if (status === 400) message = 'Dados inválidos. Revise os campos.';
        else if (status === 403) message = 'Acesso negado.';
        else if (status === 409) message = 'Conflito na operação.';
        else if (status >= 500) message = 'Erro no servidor. Tente novamente em instantes.';
        toast({
          type: 'err',
          title: status ? `Erro ${status}` : 'Erro',
          message
        });
      });

      document.body.addEventListener('htmx:afterRequest', (event) => {
        const elt = event.detail?.elt;
        const xhr = event.detail?.xhr;
        if (!shouldSkip(elt) && xhr) {
          const status = xhr.status || 0;
          const flash = parseFlash(xhr);
          const flashed = showFlash(flash, status);
          const failed = !!event.detail?.failed || status >= 400;
          if (!failed && !flashed) {
            const config = event.detail?.requestConfig || {};
            const verb = (config.verb || config.method || '').toUpperCase();
            if (verb && verb !== 'GET') {
              toast({ type: 'ok', title: 'Salvo com sucesso' });
            }
          }
        }
        finish();
      });

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && modal.classList.contains('is-open')) {
          pending = 0;
          resetModal();
        }
      });
    })();
  </script>

    <script>
      // Fallback: garante função global se static/ui/theme.js não carregar
      if (typeof window.toggleTheme !== 'function') {
        (function(){
          function applyLogoFor(theme){
            try{
              var el = document.getElementById('logo');
              if(!el) return;
              var light = el.getAttribute('data-logo-light');
              var dark = el.getAttribute('data-logo-dark');
              el.src = theme === 'dark' ? (dark || el.src) : (light || el.src);
            }catch(e){}
          }
          window.toggleTheme = function(){
            var root = document.documentElement;
            var next = (root.getAttribute('data-theme') === 'dark') ? 'light' : 'dark';
            root.setAttribute('data-theme', next);
            try{ localStorage.setItem('theme', next); }catch(e){}
            applyLogoFor(next);
          };
          // Ajusta o logo na carga inicial
          document.addEventListener('DOMContentLoaded', function(){
            var current = document.documentElement.getAttribute('data-theme') || 'light';
            applyLogoFor(current);
          });
          // Clique delegado para elementos com data-toggle-theme
          document.addEventListener('click', function(e){
            var t = e.target.closest('[data-toggle-theme]');
            if(t){ e.preventDefault(); try{ window.toggleTheme(); }catch(_){} }
          });
        })();
      }
    </script>
  </body>
</html>
