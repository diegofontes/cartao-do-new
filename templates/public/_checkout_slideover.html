{% load static currency %}
<div class="slideover" role="dialog" aria-modal="true" aria-labelledby="co-title">
  <header class="slideover-header">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2 id="co-title" class="title" style="font-size:1.25rem;margin:0">Finalizar pedido</h2>
      <button class="btn" data-close-slideover aria-label="Fechar">✕</button>
    </div>
  </header>
  <div class="slideover-body">
    {% if cart.items %}
    <div class="stack" style="gap:12px">
      <ul class="list" style="display:flex;flex-direction:column;gap:8px">
        {% for li in cart.items %}
          <li class="row between">
            <div class="row" style="gap:10px;align-items:center">
              {% if li.item.image %}
              <img class="cart-thumb" src="{% url 'media:image_public' path=li.item.image.name %}" alt="{{ li.item.name }}" />
              {% endif %}
              <div>
                <div class="strong">{{ li.item.name }}</div>
                <div class="muted">{{ li.unit_price_cents|brl_cents }} x {{ li.qty }}</div>
              </div>
            </div>
            <div>{{ li.line_subtotal_cents|brl_cents }}</div>
          </li>
        {% endfor %}
      </ul>
      <div class="row between"><div class="strong">Subtotal</div><div>{{ cart.subtotal_cents|brl_cents }}</div></div>
      <form class="stack" style="gap:10px; margin-top: 1rem;" hx-post="{% url 'delivery_checkout_submit' card.nickname %}" hx-target="#slideover" hx-swap="innerHTML">
        {% csrf_token %}
        <p class="muted" style="margin:0">Conte pra gente quem vai receber o pedido e como avisar sobre atualizações.</p>
        <label class="field"><span>Nome</span><input class="input" type="text" name="name" required />
          <small class="muted">Use seu nome completo ou de quem vai receber o pedido.</small>
        </label>
        <label class="field"><span>E-mail (opcional)</span><input class="input" type="email" name="email" />
          <small class="muted">Se informar, enviaremos o comprovante e notificações por e-mail.</small>
        </label>
        <fieldset class="box" style="grid-column:1/-1" >
          <label class="field"><span>Telefone (BR)</span>
            <input class="input" name="phone" id="co-phone" inputmode="tel" placeholder="+55 (11) 9XXXX-XXXX" data-phone-mask required />
          </label>
          <small class="muted">Digite um celular com DDD para receber o código de confirmação via SMS.</small>
          {% if phone_verified %}
            {% include 'public/_verify_block_delivery.html' with verified=True card=card %}
          {% else %}
            {% include 'public/_verify_block_delivery.html' with card=card sent=False %}
          {% endif %}
        </fieldset>
        <label class="field">
          <span>Retirada ou entrega?</span>
          <select name="fulfillment" id="ff-select" class="select" onchange="document.getElementById('addr').hidden = this.value!=='delivery'">
            <option value="pickup">Retirar</option>
            <option value="delivery">Entrega</option>
          </select>
          <small class="muted">Escolha "Retirar" para buscar no local ou "Entrega" para receber em casa.</small>
        </label>
        <div id="addr" hidden class="stack" style="gap:8px">
          <small class="muted" style="margin:0">Preencha o endereço completo para calcular a entrega.</small>
          <label class="field"><span>CEP</span>
            <input class="input" type="text" name="cep" id="co-cep"
                   hx-get="{% url 'delivery_cep_lookup' card.nickname %}"
                   hx-target="#addr-fields" hx-include="#co-cep" hx-trigger="change, keyup changed delay:1000ms" placeholder="00000-000" />
            <small class="muted">Usaremos o CEP para sugerir rua e bairro automaticamente.</small>
          </label>
          <div id="addr-fields">
            {% include 'public/_checkout_addr_fields.html' %}
          </div>
        </div>
        <label class="field"><span>Observações</span><textarea class="textarea" name="notes" rows="3"></textarea>
          <small class="muted">Compartilhe preferências de entrega ou cuidados com o pedido.</small>
        </label>
        <div class="row" style="justify-content:flex-end; margin: 15px;"><button id="co-submit" class="btn primary" {% if not phone_verified %}disabled{% endif %}>Concluir pedido</button></div>
      </form>
    </div>
    {% else %}
      <p class="muted">Seu carrinho está vazio.</p>
    {% endif %}
  </div>
  <script>
    (function(){
      function updateSubmit(){
        var v = document.getElementById('verify-dv');
        var ok = v && v.getAttribute('data-verified') === 'true';
        var btn = document.getElementById('co-submit');
        if(btn){ btn.disabled = !ok; }
      }
      document.addEventListener('htmx:afterSwap', function(evt){
        if (evt?.detail?.target && evt.detail.target.id === 'verify-dv'){
          updateSubmit();
        }
      });
      updateSubmit();
    })();
  </script>
</div>
