<div class="modal open" role="dialog" aria-modal="true" aria-labelledby="book-title" style="display:block">
  <div class="card" style="max-width:520px;margin:20px auto">
    <h3 id="book-title" style="margin-top:0">Agendar: {{ service.name }}</h3>
    <form id="book-form" hx-post="{% url 'public_create_appointment' card.nickname %}" hx-target="#booking-modal" hx-swap="innerHTML" class="grid" style="grid-template-columns:1fr 1fr;gap:10px">
      {% csrf_token %}
      <input type="hidden" name="service" value="{{ service.id }}" />
      <label class="field" style="grid-column:1/-1">
        <span>Data</span>
        <input type="date" id="book-date" class="input" required />
      </label>
      <label class="field" style="grid-column:1/-1">
        <span>Horário</span>
        <select name="start_at_utc" id="book-slot" class="select" required>
          <option value="">Selecione…</option>
        </select>
      </label>
      <label class="field">
        <span>Nome</span>
        <input name="user_name" class="input" required />
      </label>
      <label class="field">
        <span>Email</span>
        <input type="email" name="user_email" class="input" required />
      </label>
      <div class="row" style="grid-column:1/-1;justify-content:flex-end">
        <button class="btn primary">Confirmar</button>
        <button type="button" class="btn" onclick="document.getElementById('booking-modal').innerHTML=''">Cancelar</button>
      </div>
    </form>
  </div>
</div>
<script>
(function(){
  const d = document.getElementById('book-date');
  const s = document.getElementById('book-slot');
  const tz = "{{ service.timezone|escapejs }}";
  d.addEventListener('change', async ()=>{
    if(!d.value) return;
    const url = `{% url 'public_slots' card.nickname %}?service={{ service.id }}&date=${d.value}`;
    const resp = await fetch(url);
    if(!resp.ok) return;
    const data = await resp.json();
    s.innerHTML = '<option value="">Selecione…</option>';
    for (const sl of (data.slots||[])){
      const opt = document.createElement('option');
      opt.value = sl.start_at_utc;
      const t = new Date(sl.start_at_utc).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', timeZone: tz});
      opt.textContent = t;
      s.appendChild(opt);
    }
  });
})();
</script>
