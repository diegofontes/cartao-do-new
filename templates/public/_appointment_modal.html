{% load currency %}
<div class="modal open" role="dialog" aria-modal="true" aria-labelledby="book-title" style="display:block">
  <div class="card" style="max-width:520px;margin:20px auto">
    <h3 id="book-title" style="margin-top:0">Agendar: {{ service.name }}</h3>
    <p class="muted" style="margin:0 0 var(--space-2)">Valor base: {{ service.price_cents|brl_cents }} · Duração: {{ service.duration_minutes }} min</p>
    <form id="book-form"
          hx-post="{% url 'public_create_appointment' card.nickname %}"
          hx-target="#booking-modal"
          hx-swap="innerHTML"
          class="grid"
          style="grid-template-columns:1fr 1fr;gap:10px"
          data-base-price="{{ service.price_cents }}"
          data-base-duration="{{ service.duration_minutes }}">
      {% csrf_token %}
      <input type="hidden" name="service" value="{{ service.id }}" />
      <label class="field" style="grid-column:1/-1">
        <span>Data</span>
        <input type="date" id="book-date" class="input" required />
      </label>
      <label class="field" style="grid-column:1/-1">
        <span>Horário</span>
        <select name="start_at_utc" id="book-slot" class="select" required>
          <option value="">Selecione…</option>
        </select>
      </label>
      <label class="field">
        <span>Nome</span>
        <input name="name" class="input" required />
      </label>
      <label class="field">
        <span>Email</span>
        <input type="email" name="email" class="input" required />
      </label>
      <label class="field" style="grid-column:1/-1">
        <span>Telefone</span>
        <input type="tel" name="phone" class="input" required />
      </label>
      {% if options %}
        <fieldset class="box" style="grid-column:1/-1">
          <legend style="font-weight:600;margin-bottom:8px">Opções adicionais</legend>
          <ul class="grid" style="grid-template-columns:1fr;gap:8px;margin:0;padding:0;list-style:none">
            {% for opt in options %}
              <li>
                <label style="display:flex;gap:8px;align-items:flex-start">
                  <input type="checkbox"
                         name="options"
                         value="{{ opt.id }}"
                         data-price="{{ opt.price_delta_cents }}"
                         data-duration="{{ opt.extra_duration_minutes }}"
                         style="margin-top:4px" />
                  <div>
                    <div class="font-medium">{{ opt.name }}</div>
                    <div class="muted" style="font-size:12px">
                      {% if opt.price_delta_cents %}+{{ opt.price_delta_cents|brl_cents }}{% else %}Sem acréscimo{% endif %}
                      {% if opt.extra_duration_minutes %} • +{{ opt.extra_duration_minutes }} min{% endif %}
                    </div>
                    {% if opt.description %}
                      <p class="muted" style="margin:4px 0 0;font-size:12px">{{ opt.description }}</p>
                    {% endif %}
                  </div>
                </label>
              </li>
            {% endfor %}
          </ul>
        </fieldset>
      {% endif %}
      <div class="box" id="book-summary" style="grid-column:1/-1">
        <strong style="display:block;margin-bottom:4px">Resumo</strong>
        <div class="muted" style="font-size:0.9rem">
          Total estimado: <span data-summary-price>{{ service.price_cents|brl_cents }}</span><br/>
          Duração estimada: <span data-summary-duration>{{ service.duration_minutes }}</span> min
        </div>
      </div>
      <div class="row" style="grid-column:1/-1;justify-content:flex-end">
        <button class="btn primary">Confirmar</button>
        <button type="button" class="btn" onclick="document.getElementById('booking-modal').innerHTML=''">Cancelar</button>
      </div>
    </form>
  </div>
</div>
<script>
(function(){
  const d = document.getElementById('book-date');
  const s = document.getElementById('book-slot');
  const tz = "{{ service.timezone|escapejs }}";
  const summary = document.getElementById('book-summary');
  const fmt = new Intl.NumberFormat('pt-BR', { style:'currency', currency:'BRL' });
  const basePrice = parseInt((document.getElementById('book-form')?.dataset.basePrice) || '0', 10);
  const baseDuration = parseInt((document.getElementById('book-form')?.dataset.baseDuration) || '0', 10);
  function updateSummary(){
    const form = document.getElementById('book-form');
    if (!form || !summary) return;
    let price = basePrice;
    let duration = baseDuration;
    form.querySelectorAll('input[name="options"]:checked').forEach((input)=>{
      price += parseInt(input.dataset.price || '0', 10);
      duration += parseInt(input.dataset.duration || '0', 10);
    });
    const priceLabel = summary.querySelector('[data-summary-price]');
    const durationLabel = summary.querySelector('[data-summary-duration]');
    if (priceLabel) priceLabel.textContent = fmt.format(price/100);
    if (durationLabel) durationLabel.textContent = duration;
  }
  document.getElementById('book-form').addEventListener('change', (ev)=>{
    if (ev.target && ev.target.name === 'options') updateSummary();
  });
  d.addEventListener('change', async ()=>{
    if(!d.value) return;
    const url = `{% url 'public_slots' card.nickname %}?service={{ service.id }}&date=${d.value}`;
    const resp = await fetch(url);
    if(!resp.ok) return;
    const data = await resp.json();
    s.innerHTML = '<option value="">Selecione…</option>';
    for (const sl of (data.slots||[])){
      const opt = document.createElement('option');
      opt.value = sl.start_at_utc;
      const t = new Date(sl.start_at_utc).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', timeZone: tz});
      opt.textContent = t;
      s.appendChild(opt);
    }
  });
  updateSummary();
})();
</script>
