# nginx/nginx.conf
worker_processes auto;
events { worker_connections 1024; }

http {
  server_tokens off;
  sendfile on;
  tcp_nopush on;
  tcp_nodelay on;
  keepalive_timeout 65s;
  types_hash_max_size 2048;
  include       mime.types;
  default_type  application/octet-stream;

  gzip on;
  gzip_types text/plain text/css application/json application/javascript application/xml+rss image/svg+xml;

  access_log /var/log/nginx/access.log;
  error_log  /var/log/nginx/error.log warn;

  include /etc/nginx/conf.d/proxy_params.conf;

  resolver 127.0.0.11 valid=10s ipv6=off;

  upstream dashboard_upstream {
    zone dashboard 64k;
    server app-dashboard:8000 resolve;
  }

  upstream viewer_upstream {
    zone viewer 64k;
    server app-viewer:9000 resolve;
  }

  limit_req_zone $binary_remote_addr zone=rl_webhooks:10m rate=10r/s;

  server {
    listen 80;

    location = /healthz { return 200 'ok'; add_header Content-Type text/plain; }

    location ^~ /d/ {
      rewrite ^/d/?(.*)$ /$1 break;
      proxy_pass http://dashboard_upstream;
      proxy_read_timeout 60s;
      proxy_send_timeout 60s;
    }
    location = /d { return 301 /d/; }

    location ^~ /webhooks/stripe {
      include /etc/nginx/conf.d/stripe_webhooks_allow.conf;
      limit_req zone=rl_webhooks burst=20 nodelay;
      proxy_pass http://viewer_upstream;
    }

    location ^~ /webhooks/twilio {
      auth_basic           "Twilio Webhook";
      auth_basic_user_file /etc/nginx/htpasswd/twilio;
      limit_req zone=rl_webhooks burst=20 nodelay;
      proxy_pass http://viewer_upstream;
    }

    location ^~ /api/webhooks/twilio {
      auth_basic           "Twilio Webhook";
      auth_basic_user_file /etc/nginx/htpasswd/twilio;
      limit_req zone=rl_webhooks burst=20 nodelay;
      proxy_pass http://viewer_upstream;
    }

    location ^~ /webhooks/sendgrid {
      auth_basic           "SendGrid Webhook";
      auth_basic_user_file /etc/nginx/htpasswd/sendgrid;
      limit_req zone=rl_webhooks burst=20 nodelay;
      proxy_pass http://viewer_upstream;
    }

    location / {
      proxy_pass http://viewer_upstream;
      proxy_read_timeout 60s;
      proxy_send_timeout 60s;
    }
  }
}
